<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../assets/Logos/Logo-Icon.ico" type="image/x-icon">
    <title>Mes R√©servations - Ar√¥mes de Paris</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Native CSS -->
    <link rel="stylesheet" href="Client.css">
    <link rel="stylesheet" href="Profil.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/Logos/Aromes-LOGO-H.png" alt="Ar√¥mes de Paris" class="sidebar-logo">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <a href="Client.html" class="nav-item">
                <i class="fas fa-th-large"></i>
                <span>Tableau de bord</span>
            </a>
            <a href="Profil.html" class="nav-item">
                <i class="fas fa-user"></i>
                <span>Mon Profil</span>
            </a>
            <a href="MesReservations.html" class="nav-item active">
                <i class="fas fa-calendar-alt"></i>
                <span>Mes R√©servations</span>
            </a>
            <a href="../menu.html" class="nav-item">
                <i class="fas fa-utensils"></i>
                <span>Menu</span>
            </a>
            <a href="Conseils.html" class="nav-item">
                <i class="fas fa-lightbulb"></i>
                <span>Conseils</span>
            </a>
            <a href="../contact.html" class="nav-item">
                <i class="fas fa-envelope"></i>
                <span>Contact</span>
            </a>
        </nav>

        <!-- Bouton D√©connexion -->
        <div class="sidebar-footer">
            <a href="#" class="nav-item logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>D√©connexion</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
        <!-- Topbar -->
        <header class="topbar">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>

            <div class="topbar-left">
                <h1>Mes R√©servations</h1>
            </div>

            <div class="topbar-right">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <span class="user-name" id="clientName">Client</span>
                        <span class="user-role">Membre</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Reservations Content -->
        <main class="dashboard-content">
            <div class="reservations-header">
                <h2> Mes R√©servations</h2>
                <p>Consultez et g√©rez toutes vos r√©servations chez Ar√¥mes de Paris</p>
            </div>

            <!-- Statistiques Mini -->
            <div class="stats-row" id="statsRow">
                <div class="stat-mini-card">
                    <i class="fas fa-clock" style="color: #ffc107;"></i>
                    <h4 id="countEnAttente">0</h4>
                    <p>En attente</p>
                </div>
                <div class="stat-mini-card">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    <h4 id="countConfirmee">0</h4>
                    <p>Confirm√©es</p>
                </div>
                <div class="stat-mini-card">
                    <i class="fas fa-times-circle" style="color: #dc3545;"></i>
                    <h4 id="countAnnulee">0</h4>
                    <p>Annul√©es</p>
                </div>
                <div class="stat-mini-card">
                    <i class="fas fa-calendar-check" style="color: #d4af37;"></i>
                    <h4 id="countTotal">0</h4>
                    <p>Total</p>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="toutes">
                    <i class="fas fa-list"></i> Toutes
                </button>
                <button class="filter-tab" data-filter="en_attente">
                    <i class="fas fa-clock"></i> En attente
                </button>
                <button class="filter-tab" data-filter="confirmee">
                    <i class="fas fa-check-circle"></i> Confirm√©es
                </button>
                <button class="filter-tab" data-filter="annulee">
                    <i class="fas fa-times-circle"></i> Annul√©es
                </button>
            </div>

            <!-- Grille des r√©servations -->
            <div class="reservations-grid" id="reservationsGrid">
                <!-- Les r√©servations seront charg√©es ici par JavaScript -->
            </div>
        </main>
    </div>

    <script>
        // Fonction de d√©connexion
        function logout() {
            if (confirm("√ätes-vous s√ªr de vouloir vous d√©connecter ?")) {
                localStorage.removeItem('currentUser');
                window.location.href = '../connexion.html';
            }
        }
        // Charger le nom du client
        const loadClientName = () => {
            // 1. Get the currently logged-in user (The Session)
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

            // 2. Get the saved profile data (The Details)
            let userData = JSON.parse(localStorage.getItem('userData') || '{}');

            // 3. SECURITY CHECK: If the profile data belongs to a different email, ignore it!
            if (currentUser && userData.email && currentUser.email !== userData.email) {
                console.log("Cleaning up stale user data...");
                localStorage.removeItem('userData');
                userData = {}; // Reset local variable
            }

            // 4. Determine the name to display
            // Priority: currentUser (Login Name) -> userData (Profile Name) -> Default
            let nameToDisplay = 'Client';

            if (currentUser && currentUser.fullName) {
                nameToDisplay = currentUser.fullName;
            } else if (userData.nom) {
                nameToDisplay = userData.nom;
            }

            // 5. Update the HTML
            const nameElement = document.getElementById('clientName');
            const welcomeElement = document.getElementById('clientNameWelcome');

            if (nameElement) nameElement.textContent = nameToDisplay;
            if (welcomeElement) welcomeElement.textContent = nameToDisplay;
        };


        // Formater la date en fran√ßais
        function formaterDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(date).toLocaleDateString('fr-FR', options);
        }

        // Obtenir toutes les r√©servations
        function obtenirReservations() {
            try {
                const data = localStorage.getItem('reservations_restaurant');
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Erreur:', error);
                return [];
            }
        }

        // Obtenir les r√©servations du client connect√©
        function obtenirReservationsClient() {
            // Get the current user's info to compare
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const clientName = loadClientName(); // Gets the name displayed on dash
            
            // Get ALL reservations
            const reservations = obtenirReservations();

            console.log('üë§ Client connect√©:', clientName);
            if(currentUser) console.log('Email client:', currentUser.email);

            // --- FILTERING LOGIC ---
            const reservationsFiltrees = reservations.filter(r => {
                // Condition 1: Match by Email (Best & Most Accurate)
                if (currentUser && currentUser.email && r.email && r.email !== 'Non renseign√©') {
                    if (r.email.toLowerCase() === currentUser.email.toLowerCase()) {
                        return true;
                    }
                }

                // Condition 2: Match by Name (Fallback)
                // We check if the reservation name contains the client name OR vice versa
                if (clientName && r.nomComplet) {
                    const resName = r.nomComplet.toLowerCase();
                    const currentName = clientName.toLowerCase();
                    return resName.includes(currentName) || currentName.includes(resName);
                }

                return false;
            });

            console.log(`R√©servations trouv√©es: ${reservationsFiltrees.length} (sur ${reservations.length} total)`);
            
            return reservationsFiltrees;
        }

        // Afficher les statistiques
        function afficherStatistiques(reservations) {
            const enAttente = reservations.filter(r => r.statut === 'en_attente').length;
            const confirmee = reservations.filter(r => r.statut === 'confirmee').length;
            const annulee = reservations.filter(r => r.statut === 'annulee').length;

            document.getElementById('countEnAttente').textContent = enAttente;
            document.getElementById('countConfirmee').textContent = confirmee;
            document.getElementById('countAnnulee').textContent = annulee;
            document.getElementById('countTotal').textContent = reservations.length;
        }

        // Cr√©er une carte de r√©servation
        function creerCarteReservation(reservation) {
            const statusText = {
                'en_attente': 'En attente',
                'confirmee': 'Confirm√©e',
                'annulee': 'Annul√©e'
            };

            const preferenceTexte = {
                'inside': '√Ä l\'int√©rieur',
                'terrace': 'En terrasse',
                'window': 'Pr√®s de la fen√™tre',
                '': 'Aucune pr√©f√©rence'
            };

            return `
                <div class="reservation-card" data-statut="${reservation.statut}">
                    <div class="reservation-header-card">
                        <div class="reservation-id">#${reservation.id.slice(-8)}</div>
                        <span class="reservation-status status-${reservation.statut}">
                            ${statusText[reservation.statut]}
                        </span>
                    </div>
                    
                    <div class="reservation-details">
                        <div class="detail-row">
                            <i class="fas fa-user"></i>
                            <span class="detail-value">${reservation.nomComplet}</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-calendar"></i>
                            <span class="detail-value">${formaterDate(reservation.date)}</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-clock"></i>
                            <span class="detail-value">${reservation.heure}</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-users"></i>
                            <span class="detail-value">${reservation.nombrePersonnes} personne(s)</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-chair"></i>
                            <span class="detail-value">${preferenceTexte[reservation.preferenceTable]}</span>
                        </div>
                        <div class="detail-row">
                            <i class="fas fa-phone"></i>
                            <span class="detail-value">${reservation.telephone}</span>
                        </div>
                    </div>
                    
                    <div class="reservation-actions">
                        <button class="btn-action btn-details" onclick="voirDetails('${reservation.id}')">
                            <i class="fas fa-eye"></i> D√©tails
                        </button>
                        ${reservation.statut !== 'annulee' ? `
                            <button class="btn-action btn-cancel" onclick="annulerReservation('${reservation.id}')">
                                <i class="fas fa-ban"></i> Annuler
                            </button>
                        ` : `
                            <button class="btn-action btn-delete" onclick="supprimerReservation('${reservation.id}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        // Afficher les r√©servations
        function afficherReservations(filtre = 'toutes') {
            console.log('Affichage des r√©servations avec filtre:', filtre);
            const reservations = obtenirReservationsClient();
            const grid = document.getElementById('reservationsGrid');

            let reservationsFiltrees = reservations;
            if (filtre !== 'toutes') {
                reservationsFiltrees = reservations.filter(r => r.statut === filtre);
            }

            // Trier par date d√©croissante
            reservationsFiltrees.sort((a, b) => new Date(b.date) - new Date(a.date));

            console.log('R√©servations √† afficher:', reservationsFiltrees.length);

            if (reservationsFiltrees.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Aucune r√©servation trouv√©e</h3>
                        <p>Vous n'avez pas encore de r√©servation${filtre !== 'toutes' ? ' avec ce statut' : ''}.</p>
                        <a href="../reservation.html" class="btn-primary">
                            <i class="fas fa-plus"></i> Nouvelle R√©servation
                        </a>
                    </div>
                `;
            } else {
                grid.innerHTML = reservationsFiltrees.map(r => creerCarteReservation(r)).join('');
                console.log('R√©servations affich√©es avec succ√®s');
            }

            afficherStatistiques(reservations);
        }

        // Voir les d√©tails d'une r√©servation
        function voirDetails(id) {
            const reservations = obtenirReservations();
            const reservation = reservations.find(r => r.id === id);

            if (!reservation) return;

            const preferenceTexte = {
                'inside': '√Ä l\'int√©rieur',
                'terrace': 'En terrasse',
                'window': 'Pr√®s de la fen√™tre',
                '': 'Aucune pr√©f√©rence'
            };

            Swal.fire({
                title: 'D√©tails de la r√©servation',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <table style="width: 100%; font-size: 14px;">
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Num√©ro :</td>
                                <td style="padding: 10px;">${reservation.id}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Nom :</td>
                                <td style="padding: 10px;">${reservation.nomComplet}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Date :</td>
                                <td style="padding: 10px;">${formaterDate(reservation.date)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Heure :</td>
                                <td style="padding: 10px;">${reservation.heure}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Personnes :</td>
                                <td style="padding: 10px;">${reservation.nombrePersonnes}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Table :</td>
                                <td style="padding: 10px;">${preferenceTexte[reservation.preferenceTable]}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">T√©l√©phone :</td>
                                <td style="padding: 10px;">${reservation.telephone}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Email :</td>
                                <td style="padding: 10px;">${reservation.email}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: #666; font-weight: 600;">Statut :</td>
                                <td style="padding: 10px;"><strong>${reservation.statut.replace('_', ' ').toUpperCase()}</strong></td>
                            </tr>
                        </table>
                    </div>
                `,
                confirmButtonColor: '#d4af37',
                confirmButtonText: 'Fermer',
                width: '600px'
            });
        }

        // Annuler une r√©servation
        function annulerReservation(id) {
            Swal.fire({
                title: 'Annuler la r√©servation ?',
                text: '√ätes-vous s√ªr de vouloir annuler cette r√©servation ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Oui, annuler',
                cancelButtonText: 'Non, garder'
            }).then((result) => {
                if (result.isConfirmed) {
                    let reservations = obtenirReservations();
                    const index = reservations.findIndex(r => r.id === id);

                    if (index !== -1) {
                        reservations[index].statut = 'annulee';
                        reservations[index].dateModification = new Date().toISOString();
                        localStorage.setItem('reservations_restaurant', JSON.stringify(reservations));

                        Swal.fire({
                            icon: 'success',
                            title: 'R√©servation annul√©e',
                            text: 'Votre r√©servation a √©t√© annul√©e avec succ√®s.',
                            confirmButtonColor: '#d4af37'
                        });

                        afficherReservations(filtreActuel);
                    }
                }
            });
        }

        // Supprimer une r√©servation
        function supprimerReservation(id) {
            Swal.fire({
                title: 'Supprimer la r√©servation ?',
                text: 'Cette action est irr√©versible !',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    let reservations = obtenirReservations();
                    reservations = reservations.filter(r => r.id !== id);
                    localStorage.setItem('reservations_restaurant', JSON.stringify(reservations));

                    Swal.fire({
                        icon: 'success',
                        title: 'Supprim√©e',
                        text: 'La r√©servation a √©t√© supprim√©e.',
                        confirmButtonColor: '#d4af37'
                    });

                    afficherReservations(filtreActuel);
                }
            });
        }

        // Gestion des filtres
        let filtreActuel = 'toutes';
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                filtreActuel = this.dataset.filter;
                afficherReservations(filtreActuel);
            });
        });

        // Mobile menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.add('active');
        });

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.remove('active');
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initialisation de la page Mes R√©servations');
            loadClientName();
            afficherReservations();
            console.log('Page charg√©e avec succ√®s');
        });
    </script>
</body>

</html>